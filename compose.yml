services:
  # PROXY
  traefik:
    image: traefik:v3.4
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik.toml:/etc/traefik/traefik.toml
      - ./acme:/acme
    user: "0:0"  # Run as root to access acme.json
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`traefik.hdla.cloud`)
      - traefik.http.routers.traefik.entrypoints=websecure
      - traefik.http.routers.traefik.tls.certresolver=letsencrypt
      - traefik.http.routers.traefik.service=api@internal

  chhoto-url:
    image: sintan1729/chhoto-url:latest
    restart: unless-stopped
    container_name: chhoto-url
    labels:
      - traefik.enable=true
      - traefik.http.routers.chhoto-url.rule=Host(`hdla.cloud`)
      - traefik.http.routers.chhoto-url.entrypoints=websecure
      - traefik.http.routers.chhoto-url.tls.certresolver=letsencrypt
      - traefik.http.services.chhoto-url.loadbalancer.server.port=4567
      # HTTP to HTTPS redirect
      - traefik.http.routers.chhoto-url-http.rule=Host(`hdla.cloud`)
      - traefik.http.routers.chhoto-url-http.entrypoints=web
      - traefik.http.routers.chhoto-url-http.middlewares=redirect-to-https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
    environment:
      - db_url=/db/urls.sqlite
      - password=h@KFnDQ2BU7rXAKElncH5d&izDM*sTh3
    volumes:
      - ./chhoto_test/:/db
